# RAG Pro Max v2.0 æ–°åŠŸèƒ½æ–‡æ¡£

## ğŸš€ æ¦‚è¿°

RAG Pro Max v2.0 å¼•å…¥äº†ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š
- **å¢é‡æ›´æ–°** - æ™ºèƒ½æ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€é‡å»ºæ•´ä¸ªçŸ¥è¯†åº“
- **API æ¥å£æ‰©å±•** - å®Œæ•´çš„ RESTful APIï¼Œæ”¯æŒç¨‹åºåŒ–è°ƒç”¨
- **å¤šæ¨¡æ€æ”¯æŒ** - å›¾ç‰‡ OCRã€è¡¨æ ¼æå–ç­‰å¤šæ¨¡æ€å†…å®¹å¤„ç†

## ğŸ“ˆ 1. å¢é‡æ›´æ–°åŠŸèƒ½

### æ ¸å¿ƒç‰¹æ€§
- **æ™ºèƒ½å˜åŒ–æ£€æµ‹**: åŸºäºæ–‡ä»¶å“ˆå¸Œï¼Œç²¾ç¡®è¯†åˆ«æ–°å¢ã€ä¿®æ”¹ã€æœªå˜åŒ–çš„æ–‡ä»¶
- **å…ƒæ•°æ®æŒä¹…åŒ–**: è‡ªåŠ¨ä¿å­˜æ–‡ä»¶å¤„ç†çŠ¶æ€ï¼Œé‡å¯åä¿æŒçŠ¶æ€
- **é€‰æ‹©æ€§å¤„ç†**: åªå¤„ç†å˜åŒ–çš„æ–‡ä»¶ï¼Œå¤§å¹…æå‡å¤„ç†æ•ˆç‡
- **å¼ºåˆ¶æ›´æ–°**: æ”¯æŒå¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰æ–‡ä»¶

### ä½¿ç”¨æ–¹å¼

#### 1.1 ç¨‹åºåŒ–è°ƒç”¨
```python
from src.kb.kb_manager import KBManager

kb_manager = KBManager()

# æ£€æŸ¥æ–‡ä»¶å˜åŒ–
changes = kb_manager.check_incremental_changes("my_kb", [
    "/path/to/doc1.pdf",
    "/path/to/doc2.docx"
])

print(f"æ–°æ–‡ä»¶: {changes['new']}")
print(f"ä¿®æ”¹æ–‡ä»¶: {changes['modified']}")
print(f"æœªå˜åŒ–: {changes['unchanged']}")

# æ ‡è®°æ–‡ä»¶å·²å¤„ç†
kb_manager.mark_files_processed("my_kb", changes['new'] + changes['modified'])
```

#### 1.2 Web UI
1. é€‰æ‹©çŸ¥è¯†åº“
2. åœ¨ä¾§è¾¹æ æ‰¾åˆ° "ğŸ“ˆ å¢é‡æ›´æ–°" éƒ¨åˆ†
3. ä¸Šä¼ æ–‡ä»¶ï¼Œç‚¹å‡» "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–"
4. æŸ¥çœ‹å˜åŒ–æŠ¥å‘Šï¼Œç‚¹å‡» "ğŸš€ æ‰§è¡Œå¢é‡æ›´æ–°"

#### 1.3 API è°ƒç”¨
```bash
curl -X POST "http://localhost:8502/api/v2/incremental-update" \
  -H "Content-Type: application/json" \
  -d '{
    "kb_name": "my_kb",
    "file_paths": ["/path/to/doc1.pdf", "/path/to/doc2.docx"],
    "force_update": false
  }'
```

### æŠ€æœ¯å®ç°
- **å“ˆå¸Œç®—æ³•**: MD5 æ–‡ä»¶å“ˆå¸Œï¼Œå¿«é€Ÿæ£€æµ‹å˜åŒ–
- **å…ƒæ•°æ®å­˜å‚¨**: JSON æ ¼å¼ï¼Œå­˜å‚¨åœ¨çŸ¥è¯†åº“ç›®å½•
- **å¹¶å‘å®‰å…¨**: æ”¯æŒå¤šè¿›ç¨‹å®‰å…¨è®¿é—®

## ğŸ”Œ 2. API æ¥å£æ‰©å±•

### æ–°å¢æ¥å£

#### 2.1 å¢é‡æ›´æ–°æ¥å£
```
POST /api/v2/incremental-update
```
**è¯·æ±‚ä½“**:
```json
{
  "kb_name": "string",
  "file_paths": ["string"],
  "force_update": false
}
```

**å“åº”**:
```json
{
  "status": "success",
  "changes": {
    "new": ["file1.pdf"],
    "modified": ["file2.docx"],
    "unchanged": ["file3.txt"]
  },
  "processed_files": ["file1.pdf", "file2.docx"],
  "skipped_files": ["file3.txt"]
}
```

#### 2.2 å¤šæ¨¡æ€æ–‡ä»¶ä¸Šä¼ 
```
POST /api/v2/upload-multimodal
```
**å‚æ•°**:
- `kb_name`: çŸ¥è¯†åº“åç§°
- `file`: ä¸Šä¼ çš„æ–‡ä»¶

**å“åº”**:
```json
{
  "status": "success",
  "file_id": "kb_20241210_143022_image.jpg",
  "file_name": "image.jpg",
  "file_type": "image",
  "processed": true
}
```

#### 2.3 å¤šæ¨¡æ€æŸ¥è¯¢
```
POST /api/v2/query-multimodal
```
**è¯·æ±‚ä½“**:
```json
{
  "query": "string",
  "kb_name": "string",
  "include_images": true,
  "include_tables": true,
  "top_k": 5
}
```

#### 2.4 å¢é‡ç»Ÿè®¡
```
GET /api/v2/kb/{kb_name}/incremental-stats
```

### API æœåŠ¡å¯åŠ¨
```bash
# å¯åŠ¨æ‰©å±•APIæœåŠ¡
python3 -m uvicorn src.api.extended_api:extended_app --host 0.0.0.0 --port 8502

# è®¿é—®APIæ–‡æ¡£
open http://localhost:8502/docs
```

## ğŸ¨ 3. å¤šæ¨¡æ€æ”¯æŒ

### æ”¯æŒçš„æ ¼å¼

#### 3.1 å›¾ç‰‡æ ¼å¼
- **æ”¯æŒ**: JPG, JPEG, PNG, BMP, TIFF, GIF
- **åŠŸèƒ½**: OCR æ–‡å­—è¯†åˆ«
- **è¯­è¨€**: ä¸­æ–‡ç®€ä½“ + è‹±æ–‡
- **è¾“å‡º**: æ–‡å­—å†…å®¹ã€ç½®ä¿¡åº¦ã€è¯æ•°ç»Ÿè®¡

#### 3.2 è¡¨æ ¼æ ¼å¼
- **PDF è¡¨æ ¼**: ä½¿ç”¨ tabula-py æå–
- **Excel è¡¨æ ¼**: æ”¯æŒå¤šå·¥ä½œè¡¨
- **CSV æ–‡ä»¶**: ç›´æ¥è§£æ
- **è¾“å‡º**: ç»“æ„åŒ–æ•°æ®ã€CSV å­—ç¬¦ä¸²ã€HTML è¡¨æ ¼

### ä½¿ç”¨æ–¹å¼

#### 3.1 ç¨‹åºåŒ–è°ƒç”¨
```python
from src.processors.multimodal_processor import MultimodalProcessor

processor = MultimodalProcessor()

# å¤„ç†å›¾ç‰‡
result = processor.extract_text_from_image("image.jpg")
print(f"è¯†åˆ«æ–‡å­—: {result['text']}")
print(f"ç½®ä¿¡åº¦: {result['confidence']:.1f}%")

# å¤„ç†è¡¨æ ¼
tables = processor.extract_tables_from_pdf("document.pdf")
for table in tables:
    print(f"è¡¨æ ¼ {table['table_id']}: {table['shape']}")
    print(table['csv_string'])

# ç»¼åˆå¤„ç†
result = processor.process_multimodal_file("multimodal_doc.pdf")
print(f"æ–‡æœ¬å†…å®¹: {result['text_content']}")
print(f"å›¾ç‰‡æ•°é‡: {len(result['images'])}")
print(f"è¡¨æ ¼æ•°é‡: {len(result['tables'])}")
```

#### 3.2 Web UI
1. é€‰æ‹©çŸ¥è¯†åº“
2. åœ¨ä¾§è¾¹æ æ‰¾åˆ° "ğŸ¨ å¤šæ¨¡æ€æ”¯æŒ" éƒ¨åˆ†
3. ä¸Šä¼ å¤šæ¨¡æ€æ–‡ä»¶
4. æŸ¥çœ‹æå–ç»“æœï¼ˆæ–‡å­—ã€è¡¨æ ¼ï¼‰
5. æ‰§è¡Œå¤šæ¨¡æ€æŸ¥è¯¢

### ä¾èµ–è¦æ±‚

#### 3.1 ç³»ç»Ÿä¾èµ–
```bash
# macOS
brew install tesseract tesseract-lang

# Ubuntu/Debian
sudo apt-get install tesseract-ocr tesseract-ocr-chi-sim tesseract-ocr-eng

# CentOS/RHEL
sudo yum install tesseract tesseract-langpack-chi_sim tesseract-langpack-eng
```

#### 3.2 Python ä¾èµ–
```bash
pip install Pillow pytesseract tabula-py pandas xlrd xlwt lxml
```

#### 3.3 Java ç¯å¢ƒ
è¡¨æ ¼æå–éœ€è¦ Java 8+ ç¯å¢ƒï¼š
```bash
# æ£€æŸ¥ Java
java -version

# å®‰è£… Java (å¦‚æœéœ€è¦)
# macOS: brew install openjdk
# Ubuntu: sudo apt-get install openjdk-8-jdk
```

## ğŸš€ 4. éƒ¨ç½²å’Œä½¿ç”¨

### 4.1 å¿«é€Ÿéƒ¨ç½²
```bash
# è¿è¡Œ v2.0 éƒ¨ç½²è„šæœ¬
./scripts/deploy_v2.sh

# å¯åŠ¨å®Œæ•´æœåŠ¡
./start_v2.sh
```

### 4.2 æœåŠ¡è®¿é—®
- **ä¸»åº”ç”¨**: http://localhost:8501
- **API æ–‡æ¡£**: http://localhost:8502/docs
- **API åŸºç¡€åœ°å€**: http://localhost:8502/api/v2

### 4.3 åŠŸèƒ½éªŒè¯
```bash
# è¿è¡Œ v2.0 åŠŸèƒ½æµ‹è¯•
python3 tests/test_v2_features.py

# è¿è¡Œå®Œæ•´æµ‹è¯•
python3 tests/factory_test.py
```

## ğŸ”§ 5. é…ç½®å’Œä¼˜åŒ–

### 5.1 OCR é…ç½®
```python
# åœ¨ MultimodalProcessor ä¸­é…ç½®
processor = MultimodalProcessor()
processor.ocr_languages = 'chi_sim+eng+fra'  # æ·»åŠ æ³•è¯­æ”¯æŒ
```

### 5.2 è¡¨æ ¼æå–ä¼˜åŒ–
```python
# è°ƒæ•´ tabula å‚æ•°
tables = tabula.read_pdf(
    pdf_path, 
    pages='all',
    multiple_tables=True,
    lattice=True,  # ä½¿ç”¨æ ¼çº¿æ£€æµ‹
    stream=False   # ç¦ç”¨æµæ¨¡å¼
)
```

### 5.3 å¢é‡æ›´æ–°ä¼˜åŒ–
```python
# è‡ªå®šä¹‰å“ˆå¸Œç®—æ³•
class CustomIncrementalUpdater(IncrementalUpdater):
    def _calculate_file_hash(self, file_path: str) -> str:
        # ä½¿ç”¨ SHA256 æ›¿ä»£ MD5
        import hashlib
        hash_sha256 = hashlib.sha256()
        with open(file_path, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                hash_sha256.update(chunk)
        return hash_sha256.hexdigest()
```

## ğŸ“Š 6. æ€§èƒ½æŒ‡æ ‡

### 6.1 å¢é‡æ›´æ–°æ€§èƒ½
- **æ–‡ä»¶æ£€æµ‹**: ~1000 æ–‡ä»¶/ç§’
- **å“ˆå¸Œè®¡ç®—**: ~100MB/ç§’
- **å…ƒæ•°æ®åŠ è½½**: <100ms

### 6.2 å¤šæ¨¡æ€å¤„ç†æ€§èƒ½
- **å›¾ç‰‡ OCR**: ~2-5ç§’/å›¾ç‰‡ (å–å†³äºåˆ†è¾¨ç‡)
- **PDF è¡¨æ ¼æå–**: ~1-3ç§’/é¡µ
- **Excel å¤„ç†**: ~0.1-0.5ç§’/å·¥ä½œè¡¨

### 6.3 API å“åº”æ—¶é—´
- **å¢é‡æ›´æ–°æ£€æŸ¥**: <500ms
- **æ–‡ä»¶ä¸Šä¼ **: å–å†³äºæ–‡ä»¶å¤§å°
- **å¤šæ¨¡æ€æŸ¥è¯¢**: 1-3ç§’

## ğŸ› 7. æ•…éšœæ’é™¤

### 7.1 OCR é—®é¢˜
**é—®é¢˜**: `pytesseract.TesseractNotFoundError`
**è§£å†³**: 
```bash
# æ£€æŸ¥ tesseract å®‰è£…
which tesseract

# è®¾ç½®è·¯å¾„ (å¦‚æœéœ€è¦)
export PATH="/usr/local/bin:$PATH"
```

### 7.2 è¡¨æ ¼æå–é—®é¢˜
**é—®é¢˜**: `java.lang.RuntimeException`
**è§£å†³**:
```bash
# æ£€æŸ¥ Java ç¯å¢ƒ
java -version

# å®‰è£… Java
sudo apt-get install openjdk-8-jdk
```

### 7.3 API è®¿é—®é—®é¢˜
**é—®é¢˜**: ç«¯å£è¢«å ç”¨
**è§£å†³**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :8502

# ä½¿ç”¨å…¶ä»–ç«¯å£
uvicorn src.api.extended_api:extended_app --port 8503
```

## ğŸ“š 8. ç¤ºä¾‹ä»£ç 

### 8.1 å®Œæ•´å·¥ä½œæµç¤ºä¾‹
```python
import asyncio
from src.kb.kb_manager import KBManager
from src.processors.multimodal_processor import MultimodalProcessor

async def complete_workflow():
    kb_manager = KBManager()
    processor = MultimodalProcessor()
    
    # 1. åˆ›å»ºçŸ¥è¯†åº“
    success, msg = kb_manager.create("demo_kb")
    print(f"åˆ›å»ºçŸ¥è¯†åº“: {msg}")
    
    # 2. å‡†å¤‡æ–‡ä»¶
    files = ["doc1.pdf", "image1.jpg", "table1.xlsx"]
    
    # 3. æ£€æŸ¥å¢é‡å˜åŒ–
    changes = kb_manager.check_incremental_changes("demo_kb", files)
    print(f"éœ€è¦å¤„ç†çš„æ–‡ä»¶: {len(changes['new']) + len(changes['modified'])}")
    
    # 4. å¤„ç†å¤šæ¨¡æ€æ–‡ä»¶
    for file_path in changes['new'] + changes['modified']:
        result = processor.process_multimodal_file(file_path)
        print(f"å¤„ç† {file_path}: {result['file_type']}")
        
        # TODO: å°†ç»“æœæ·»åŠ åˆ°çŸ¥è¯†åº“
        
    # 5. æ ‡è®°å·²å¤„ç†
    kb_manager.mark_files_processed("demo_kb", changes['new'] + changes['modified'])
    
    # 6. æ‰§è¡Œå¤šæ¨¡æ€æŸ¥è¯¢
    query_result = await processor.query(
        kb_name="demo_kb",
        query="è¡¨æ ¼ä¸­çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Ÿ",
        include_images=True,
        include_tables=True
    )
    print(f"æŸ¥è¯¢ç»“æœ: {query_result['answer']}")

# è¿è¡Œç¤ºä¾‹
asyncio.run(complete_workflow())
```

### 8.2 API å®¢æˆ·ç«¯ç¤ºä¾‹
```python
import requests
import json

class RAGProMaxClient:
    def __init__(self, base_url="http://localhost:8502"):
        self.base_url = base_url
    
    def incremental_update(self, kb_name, file_paths, force_update=False):
        url = f"{self.base_url}/api/v2/incremental-update"
        data = {
            "kb_name": kb_name,
            "file_paths": file_paths,
            "force_update": force_update
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def upload_multimodal(self, kb_name, file_path):
        url = f"{self.base_url}/api/v2/upload-multimodal"
        with open(file_path, 'rb') as f:
            files = {'file': f}
            data = {'kb_name': kb_name}
            response = requests.post(url, files=files, data=data)
        return response.json()
    
    def query_multimodal(self, kb_name, query, include_images=True, include_tables=True):
        url = f"{self.base_url}/api/v2/query-multimodal"
        data = {
            "query": query,
            "kb_name": kb_name,
            "include_images": include_images,
            "include_tables": include_tables
        }
        response = requests.post(url, json=data)
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
client = RAGProMaxClient()

# å¢é‡æ›´æ–°
result = client.incremental_update("my_kb", ["doc1.pdf", "doc2.docx"])
print(f"å¤„ç†äº† {len(result['processed_files'])} ä¸ªæ–‡ä»¶")

# ä¸Šä¼ å¤šæ¨¡æ€æ–‡ä»¶
result = client.upload_multimodal("my_kb", "image.jpg")
print(f"ä¸Šä¼ æˆåŠŸ: {result['file_id']}")

# å¤šæ¨¡æ€æŸ¥è¯¢
result = client.query_multimodal("my_kb", "å›¾ç‰‡ä¸­æ˜¾ç¤ºäº†ä»€ä¹ˆï¼Ÿ")
print(f"ç­”æ¡ˆ: {result['answer']}")
```

## ğŸ¯ 9. è·¯çº¿å›¾

### v2.1 è®¡åˆ’åŠŸèƒ½
- [ ] **å®æ—¶æ–‡ä»¶ç›‘æ§**: ä½¿ç”¨ watchdog è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–
- [ ] **æ‰¹é‡ OCR ä¼˜åŒ–**: å¹¶è¡Œå¤„ç†å¤šä¸ªå›¾ç‰‡
- [ ] **è¡¨æ ¼æ™ºèƒ½è§£æ**: è‡ªåŠ¨è¯†åˆ«è¡¨æ ¼ç»“æ„å’Œè¯­ä¹‰
- [ ] **å¤šæ¨¡æ€å‘é‡åŒ–**: å›¾ç‰‡å’Œè¡¨æ ¼çš„å‘é‡è¡¨ç¤º

### v2.2 è®¡åˆ’åŠŸèƒ½
- [ ] **åˆ†å¸ƒå¼å¤„ç†**: æ”¯æŒå¤šæœºå™¨ååŒå¤„ç†
- [ ] **ç¼“å­˜ä¼˜åŒ–**: OCR å’Œè¡¨æ ¼æå–ç»“æœç¼“å­˜
- [ ] **è´¨é‡è¯„ä¼°**: å¤šæ¨¡æ€å†…å®¹è´¨é‡è‡ªåŠ¨è¯„ä¼°
- [ ] **ç”¨æˆ·æƒé™**: å¤šç”¨æˆ·å¤šçŸ¥è¯†åº“æƒé™ç®¡ç†

---

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ [æ•…éšœæ’é™¤](#7-æ•…éšœæ’é™¤) éƒ¨åˆ†
2. è¿è¡Œæµ‹è¯•éªŒè¯: `python3 tests/test_v2_features.py`
3. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“
4. æŸ¥çœ‹ API æ–‡æ¡£: http://localhost:8502/docs

**v2.0 è®© RAG Pro Max æ›´æ™ºèƒ½ã€æ›´é«˜æ•ˆã€æ›´å¼ºå¤§ï¼** ğŸš€
