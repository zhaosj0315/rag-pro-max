# RAG Pro Max v1.6 新功能

## 🎯 功能概述

v1.6 版本新增三大核心功能：
1. **查询改写 (Query Rewriting)** - 自动优化用户查询，提升检索准确率
2. **文档预览 (Document Preview)** - 上传前/后预览文档，精细化管理知识库
3. **智能命名 (Smart Naming)** - 自动生成有意义的知识库名称

---

## 1. 查询改写 (Query Rewriting)

### 功能说明

自动检测并优化不清晰的用户查询，提升检索准确率 5-10%。

### 触发条件

系统会在以下情况自动建议改写：
- ✅ 查询过短（<5字）
- ✅ 包含口语化表达（"啥"、"咋"、"咋样"等）
- ✅ 检索结果相似度低（<0.5）

### 使用示例

**场景 1：短查询**
```
用户输入：RAG是啥
系统建议：什么是RAG技术？它的工作原理是什么？
```

**场景 2：口语化查询**
```
用户输入：这个咋用啊
系统建议：如何使用这个功能？请提供详细的使用步骤。
```

### 用户交互

当系统检测到需要改写时，会显示：

```
💡 查询优化建议

原问题：RAG是啥

优化后：什么是RAG技术？它的工作原理和应用场景是什么？

[✅ 使用优化后的问题]  [❌ 使用原问题]
```

---

## 2. 文档预览 (Document Preview)

### 功能说明

支持在上传前/后预览文档内容，查看已索引的文档片段，精细化管理知识库。

### 上传前预览

**特性**：
- 📄 支持多文件预览（带翻页，每页10个）
- 👁️ 点击预览按钮查看文档内容
- 📊 显示文件大小和类型

**界面**：
```
📄 已选择 3 个文件 - 点击预览
  [⬅️ 上一页]  第 1/1 页  [下一页 ➡️]
  
  📎 CASE.pdf              1.8 MB    [👁️]
  📎 如何阅读一本书.pdf     16.4 MB   [👁️]
  📎 读书是一辈子的事.pdf   1.2 MB    [👁️]
```

**支持格式**：
- ✅ 文本文件：TXT, MD, JSON, CSV（完整支持）
- ✅ PDF 文件：前 3 页内容
- ✅ DOCX 文件：前 10 段落

### 知识库文档列表

在"📊 知识库详情与管理"→"📄 文档列表"标签页：

```
📚 文档列表 (4)

📄 CASE.pdf        1.72 MB    [👁️]  [🗑️]
📄 技术文档.pdf     15.61 MB   [👁️]  [🗑️]
```

**功能**：
- 👁️ 查看文档详情（内容预览 + 分块信息）
- 🗑️ 删除文档（从知识库移除）

---

## 3. 智能命名 (Smart Naming)

### 功能说明

自动生成有意义的知识库名称，无需手动输入。

### 命名规则

**单文件**：
- 使用文件名（去扩展名）
- 例：`Python教程.pdf` → `Python教程_20251209`

**多文件**：
- 根据主要文件类型生成
- PDF/DOCX → `文档集合_20251209`
- MD/TXT → `笔记集合_20251209`
- PY/JS/JAVA → `代码库_20251209`
- XLSX/CSV → `数据集_20251209`

**日期后缀**：
- 格式：`YYYYMMDD`（如 `20251209`）
- 避免重名冲突

### 用户体验

```
知识库名称
💡 建议名称：文档集合_20251209
[_____________________________]
留空自动生成，或输入自定义名称
```

- ✅ 留空使用自动名称
- ✅ 输入自定义名称覆盖
- ✅ 不强制，灵活易用

---

## 🔧 技术实现

### 查询改写
```python
# src/query/query_rewriter.py
class QueryRewriter:
    def should_rewrite(self, query: str, top_score: float) -> Tuple[bool, str]
    def rewrite(self, query: str, context: Optional[str]) -> str
```

### 文档预览
```python
# src/kb/document_viewer.py
class DocumentViewer:
    def get_kb_documents(self, kb_name: str) -> List[DocumentInfo]
    def preview_file(self, file_path: str, max_chars: int) -> str
    def get_document_chunks(self, kb_name: str, file_path: str) -> List[Dict]
```

### 智能命名
```python
# 自动分析文件类型生成名称
if main_ext in ['PDF', 'DOCX']:
    auto_name = "文档集合"
elif main_ext in ['MD', 'TXT']:
    auto_name = "笔记集合"
# ... 添加日期后缀
auto_name = f"{auto_name}_{date_suffix}"
```

---

## 📊 改进点

### v1.6 最终版改进

1. **文档预览优化**
   - ✅ 改为折叠面板 + 翻页（每页10个）
   - ✅ 预览按钮显示在文件列表旁
   - ✅ 使用对话框显示预览内容
   - ✅ 避免多对话框冲突

2. **队列处理优化**
   - ✅ 自动处理队列中的问题
   - ✅ 避免切换知识库时中断对话
   - ✅ 显示队列状态和进度

3. **智能命名**
   - ✅ 根据文件类型自动生成
   - ✅ 添加完整日期后缀（YYYYMMDD）
   - ✅ 不强制输入，提升易用性

---

## 🎯 预期效果

- 🎯 **查询准确率提升** 5-10%
- 📄 **文档管理更便捷** 可视化预览和管理
- 💡 **用户体验优化** 智能命名，无需思考
- 🚀 **功能完整性** 覆盖核心需求

---

## 📝 使用指南

### 查询改写
1. 输入短查询或口语化问题
2. 系统自动显示改写建议
3. 选择使用优化后的问题或原问题

### 文档预览
1. 上传文件后，展开"📄 已选择 X 个文件"
2. 点击"👁️"按钮预览文档
3. 在知识库详情中查看已索引文档

### 智能命名
1. 上传文件后，系统自动生成建议名称
2. 留空使用自动名称，或输入自定义名称
3. 点击"🚀 立即创建"

---

**版本**: v1.6.0 (最终版)  
**日期**: 2025-12-09  
**状态**: ✅ 完成并优化
