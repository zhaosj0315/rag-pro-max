# RAG Pro Max v1.5.1 发布说明

**发布日期**: 2025-12-09  
**版本类型**: 功能增强版本  
**状态**: ✅ 稳定可用

---

## 🎯 版本概述

v1.5.1 是 v1.5.0 的功能增强版本，专注于用户体验优化和系统可用性提升。

### 核心改进
1. **性能监控** - 实时查看查询性能和统计信息
2. **推荐优化** - 结合知识库内容，生成更相关的推荐问题
3. **错误恢复** - 自动重试机制，友好错误提示
4. **单例优化** - LogManager 单例模式，性能数据全局共享

---

## 🚀 新增功能

### 1. 性能监控面板
**位置**: 侧边栏 → 📊 性能监控

**功能**:
- 查询性能统计（平均/最快/最慢耗时）
- 查询统计（总查询数、总耗时）
- 最近查询详情（耗时、检索文档数）
- 刷新和清空操作

**技术实现**:
- LogManager 单例模式，全局共享性能数据
- 自动记录所有 timer 操作
- 实时汇总和展示

---

### 2. 推荐问题优化
**位置**: 对话后自动显示 / 侧边栏 → 💡 推荐问题管理

**功能**:
- **智能生成**: 结合知识库内容和对话上下文
- **关键词提取**: 使用 jieba 分词提取关键词
- **知识库查询**: 获取相关文档主题
- **自定义推荐**: 添加/删除自定义推荐问题
- **历史记录**: 查看最近生成的推荐问题
- **持久化存储**: 推荐问题自动保存到磁盘

**技术实现**:
```python
# 1. 提取关键词
keywords = _extract_keywords(context_text)

# 2. 查询知识库（兼容 chat 和 query 方法）
if hasattr(query_engine, 'chat'):
    kb_response = query_engine.chat(kb_query)

# 3. 获取相关主题
topics = [node.metadata['file_name'] for node in kb_response.source_nodes]

# 4. 生成问题
prompt = f"...结合知识库内容...\n知识库相关主题：{topics}\n..."
```

**效果对比**:
- **之前**: 固定的几个问题，不够相关
- **现在**: 每次不同，贴合知识库内容和对话上下文

---

### 3. 错误恢复机制
**功能**:
- **自动重试**: 可配置重试次数、延迟、倍增因子
- **友好提示**: 9种常见错误的友好消息
- **恢复建议**: 针对性的解决方案
- **装饰器支持**: `@retry_on_error` 和 `@handle_errors`

**使用示例**:
```python
from src.utils.error_handler import retry_on_error

@retry_on_error(max_retries=3, delay=1.0, backoff=2.0)
def unstable_function():
    # 可能失败的操作
    pass
```

---

## 🐛 已修复问题

### 关键修复
1. **性能监控无数据** - end_timer 未记录性能指标
2. **LogManager 多实例** - 改为单例模式，数据全局共享
3. **推荐问题不变化** - 结合知识库内容，智能生成
4. **推荐问题不显示** - 移除有问题的验证逻辑

### 技术细节
- `end_timer()` 添加性能指标记录到 metrics
- `LogManager.__new__()` 实现单例模式
- `_extract_keywords()` 使用 jieba 分词
- 兼容 `ContextChatEngine` 的 `chat()` 方法

---

## 📊 测试结果

### 可行性测试
- ✅ 通过: **7/7**
- ❌ 失败: **0/7**

测试项目:
1. ✅ 性能监控模块
2. ✅ LogManager 单例
3. ✅ 推荐引擎增强
4. ✅ 推荐问题生成
5. ✅ 推荐问题面板
6. ✅ 错误处理增强
7. ✅ 语法检查

### 出厂测试
- ✅ 通过: **58/63**
- ❌ 失败: **0/63**
- ⏭️ 跳过: **5/63**

---

## 📝 代码统计

### 新增文件
- `src/ui/performance_monitor.py` (100行)
- `src/ui/suggestion_panel.py` (130行)
- `suggestion_history/` (历史存储目录)

### 修改文件
- `src/chat/suggestion_engine.py` (+80行)
- `src/utils/error_handler.py` (+70行)
- `src/logging/log_manager.py` (+20行，单例模式)
- `src/chat_utils_improved.py` (+50行，关键词提取和知识库查询)
- `.gitignore` (添加 suggestion_history)

### 总计
- 新增: **+450 行**
- 修改: **+150 行**
- 总计: **+600 行**

---

## 🎯 使用指南

### 性能监控
1. 启动应用
2. 在侧边栏找到 **📊 性能监控**
3. 进行对话查询
4. 实时查看性能统计

### 推荐问题
1. 进行对话查询
2. 查看回答后自动显示的推荐问题
3. 点击问题按钮直接提问
4. 在 **💡 推荐问题管理** 中添加自定义推荐

### 错误恢复
- 系统自动处理错误
- 显示友好错误消息
- 提供恢复建议
- 自动重试失败操作

---

## 🔄 升级说明

### 从 v1.5.0 升级
1. 拉取最新代码：`git pull origin main`
2. 清理缓存：`find . -name "*.pyc" -delete`
3. 重启应用即可使用新功能

### 兼容性
- ✅ 完全向后兼容 v1.5.0
- ✅ 不影响现有功能
- ✅ 不需要重建知识库

---

## 📚 相关文档

- [v1.5.0 发布说明](RELEASE_v1.5.0.md)
- [v1.5.1 可行性测试](tests/test_v1.5.1_feasibility.py)
- [操作手册](USER_MANUAL.md)
- [更新日志](CHANGELOG.md)
- [README.md](README.md)

---

## 🎯 下一步计划

### v1.5.2 (计划中)
- [ ] 查询缓存持久化
- [ ] 性能优化
- [ ] UI/UX 改进

---

## 🙏 致谢

感谢所有用户的反馈和建议！

---

**发布负责人**: AI Assistant  
**审核日期**: 2025-12-09  
**发布日期**: 2025-12-09
