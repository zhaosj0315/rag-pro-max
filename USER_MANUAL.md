# RAG Pro Max v2.7.3 操作手册

**版本: v2.7.3**  
**更新日期**: 2025-12-28  
**核心特性**: 知识库增量高级处理、30+项属性挖掘、macOS深度集成、智能溯源系统

---

## 📑 目录

1. [快速入门](#1-快速入门)
2. [终极文件详情档案](#2-终极文件详情档案)
3. [智能溯源系统](#3-智能溯源系统)
4. [macOS深度集成](#4-macos深度集成)
5. [核心功能详解](#5-核心功能详解)
6. [常见问题](#6-常见问题)

---

## 1. 快速入门

### 1.1 启动应用
- **图形界面**: 运行 `./start.sh` 或 `streamlit run src/apppro.py`
- **Web 访问**: 浏览器打开 `http://localhost:8501`

### 1.2 创建知识库
1. **路径输入**: 侧边栏支持手动粘贴本地目录路径
2. **数据源选择**: 
   - `📂 文件上传`: 拖拽文件，支持批量上传
   - `📝 粘贴文本`: 自动将文字保存为文件
   - `🔗 网址抓取`: 递归抓取网页，自动注入溯源URL

### 1.3 管理与更新知识库 (v2.7.3 新增)
在侧边栏选择已有的知识库后，进入**管理模式**。
1. **追加文档**: 通过文件上传组件选择新文件。
2. **高级选项 (本次更新有效)**: 
   上传文件后，会出现**高级选项**面板，您可以针对本次追加的文件开启：
   - **🔍 OCR识别**: 强制对图片/扫描PDF进行文字识别。
   - **📊 元数据**: 提取文件的分类标签和关键词。
   - **📝 生成摘要**: 自动生成并索引AI摘要。
   - **✅ 一键全选**: 快速启用所有增强功能。
3. **执行更新**: 点击“🔄 更新知识库”即可将处理后的新文件并入现有索引。

### 1.4 模型与对话配置 (v2.7.3 优化)
进入 **“⚙️ 配置”** 标签页，您可以体验全新的 **双栏管理界面**：
1. **左侧选择服务商**: 支持 Ollama (本地), OpenAI, Azure, Gemini, Anthropic 等。
2. **右侧配置连接**: 输入对应的 API Key 或 Endpoint。
3. **对话设置**:
   - **附带历史消息数 (Context Window)**: 控制模型在对话时“记得”多少轮之前的对话。滑块范围 1-50。
4. **保存生效**: 每个服务商均有独立保存按钮，点击后配置立即生效（Hot Reload），无需重启。

---

## 2. 终极文件详情档案

### 2.1 健康仪表盘
文件详情页顶部显示4个彩色状态Badge：
- **🟢 索引状态**: 已完成/待处理
- **🔵 存储效率**: 逻辑大小与物理占用比率
- **🟡 内容热度**: 历史点击/命中频次  
- **🟣 存活天数**: 文件创建时长统计

### 2.2 60/40黄金分割布局

#### 左侧(60%) - 智能洞察
- **AI摘要**: 自动生成文件内容摘要
- **Token预估**: 基于字符分布预估LLM中的Token占用
- **内容密度**: 字符与向量片段的比例分析
- **文本预览**: 前800字符实时预览
- **用户备注**: 支持实时编辑和持久化存储

#### 右侧(40%) - 档案专家
- **基础信息**: 文件名、大小、路径、修改时间
- **系统属性**: 权限、所有者、文件系统类型
- **取证信息**: Magic Bytes、SHA-256指纹、Inode编号
- **macOS专属**: Finder标签、系统注释、溯源URL

### 2.3 30+项属性详解

#### 🕵️ 数据取证级属性
- **Magic Bytes**: 文件头十六进制特征码(如: 55 52 4C 3A)
- **SHA-256指纹**: 全量强哈希，文件唯一身份证
- **Inode编号**: 文件系统节点标识
- **硬链接数**: 指向同一文件的链接数量
- **设备ID**: 文件所在磁盘设备标识
- **文件系统**: APFS/NTFS/ext4等格式识别

#### 📊 存储分析
- **逻辑大小**: 文件实际内容大小
- **物理占用**: 磁盘实际占用空间
- **存储效率**: 逻辑/物理比率(识别稀疏文件)
- **符号链接**: 自动解析并显示真实路径

#### ⏰ 时间轴分析
- **创建时间**: 文件首次创建时间
- **修改时间**: 内容最后修改时间  
- **元数据变更**: 属性最后变更时间
- **最后访问**: 文件最后被访问时间

---

## 3. 智能溯源系统

### 3.1 双重校验机制
- **文件头解析**: 自动读取抓取文件第一行的URL信息
- **系统元数据**: 注入macOS的kMDItemWhereFroms属性
- **容错处理**: 支持URL:/url:不区分大小写，宽容空格处理

### 3.2 网页抓取溯源
1. 使用网页抓取功能获取内容
2. 系统自动将原始URL写入文件第一行
3. 同时注入到macOS系统元数据
4. 文件详情中显示"🌐 溯源 (系统记录)"

---

## 4. macOS深度集成

### 4.1 Finder原生功能
- **📂 在Finder中显示**: 一键定位文件并闪烁高亮
- **Finder标签**: 胶囊化展示系统原生颜色标签
- **系统注释**: 同步显示Finder中的用户注释

### 4.2 QuickLook智能预览
- **AppleScript置顶**: 预览窗口自动推到最前端
- **循环监听**: 2秒监控确保窗口可见
- **防遮挡设计**: 即使浏览器全屏也能看到预览

### 4.3 Spotlight集成
- **mdls命令**: 深度抓取系统元数据
- **版本信息**: 提取应用/文档内部版本号
- **作者信息**: 显示文档创建者信息

---

## 5. 核心功能详解

### 5.1 双备注系统
- **macOS原生注释**: 显示系统Finder中的注释
- **AI专有备注**: 本系统独立的备注功能
- **持久化存储**: 备注数据保存到本地JSON文件

### 5.2 安全文件管理
- **跨平台兼容**: reveal_in_file_manager函数支持Mac/Win/Linux
- **防注入保护**: 使用参数列表化调用，杜绝路径注入漏洞
- **异常处理**: 处理文件移动、删除、权限不足等边缘情况

### 5.3 性能优化
- **按需计算**: 深度属性仅在展开详情时计算
- **大小保护**: 超过100MB文件跳过实时哈希计算
- **编码容错**: 文本预览采用流式读取，自动处理字符集

---

## 6. 常见问题

### Q: 文件详情显示不完整？
A: 确保文件权限正常，某些系统文件可能需要管理员权限才能获取完整属性。

### Q: QuickLook预览被遮挡？
A: v2.7.1已集成AppleScript自动置顶功能，预览窗口会自动推到最前端。

### Q: 溯源信息不显示？
A: 溯源功能仅对通过网页抓取获取的文件有效，手动上传的文件不会有溯源信息。

### Q: Magic Bytes显示异常？
A: 某些文件格式可能没有标准的Magic Bytes，系统会显示实际的文件头内容。

### Q: SHA-256计算很慢？
A: 大文件(>100MB)会跳过实时哈希计算以保护性能，可以手动触发计算。
    - `🔍 智能搜索`: 输入关键词，AI 自动搜集高质量网页。
3.  **高级选项**: 建议开启 `📊 提取元数据` 以获得最佳的深度分析体验。

---

## 2. 深度档案管理

v2.6.1 引入了全新的 **Split View 文件分析面板**，提供取证级的文档信息：

### 2.1 健康仪表盘 (Dashboard)
详情页顶部实时显示：
- **索引状态**: 是否已成功向量化。
- **存储效率**: 物理磁盘占用的优化比例。
- **内容热度**: 在对话中被命中的频次。
- **存活天数**: 文档自创建以来的时间动力学。

### 2.2 60/40 深度视图
*   **🧠 智能洞察 (左侧)**: 
    - **RAG 动力学**: 查看预估 Token、向量片段分布及内容密度。
    - **内容采样**: 自动预览文本前 800 字符。
    - **持久化备注**: 实时记录文件备注，数据永久保存在本地。
*   **🕵️ 技术档案 (右侧)**:
    - **🍎 macOS 增强**: 自动同步 Finder 标签、系统注释及原始下载 URL。
    - **系统取证**: 显示 Magic Bytes (文件头特征)、SHA-256 强指纹、Inode 及文件系统类型。
    - **拓扑位置**: 解析真实物理路径，识别符号链接。

---

## 3. 智能溯源系统

**解决“数据从哪来”的核心问题：**
- **全自动注入**: 在网页抓取或智能搜索时，系统会自动将原始 URL 写入文件首行，并利用 `xattr` 技术注入 macOS 扩展属性。
- **证据链闭环**: 您可以在详情面板的 **“🌐 溯源 (系统记录)”** 栏目中随时点击查看该知识点的原始出处。

---

## 4. 核心功能详解

### 👁️ macOS 原生预览与集成
- **QuickLook**: 点击 `👁️` 图标，系统将利用 AppleScript 强制将预览窗口弹出在所有应用的最前端。
- **Finder 定位**: 点击“在 Finder 中显示”，快速在系统文件管理器中定位目标。

### 📊 自动化摘要
- 系统支持选中多个文档批量生成 AI 摘要，摘要会自动索引，显著提升语义检索的召回率。

---

## 5. 常见问题

**Q: 为什么某些文件看不到“下载来源”？**
A: “下载来源”由系统在抓取时自动记录。如果是您手动创建或通过 U 盘拷贝的文件，可能不带此元数据。

**Q: 如何保存对文件的修改备注？**
A: 直接在详情面板的文本框输入即可，失去焦点后系统会自动保存并提示“✅ 备注已保存”。

---
*Copyright © 2025 RAG Pro Max Team. All rights reserved.*
