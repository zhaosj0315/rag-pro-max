#!/usr/bin/env python3
"""
KBLlama - Ollama é£æ ¼çš„çŸ¥è¯†åº“ç®¡ç†å·¥å…·
ç”¨æ³•ç±»ä¼¼ Ollama: kbllama list, kbllama pull, kbllama run
"""
import os
import sys
import argparse
from kb_package import KnowledgeBasePackager

class KBLlama:
    """Ollama é£æ ¼çš„çŸ¥è¯†åº“ç®¡ç†å™¨"""
    
    def __init__(self):
        self.packager = KnowledgeBasePackager()
    
    def list(self):
        """åˆ—å‡ºæ‰€æœ‰çŸ¥è¯†åº“ï¼ˆç±»ä¼¼ ollama listï¼‰"""
        print(f"{'NAME':<40} {'ID':<16} {'SIZE':<10} {'MODIFIED'}")
        
        # åˆ—å‡ºå·²æ‰“åŒ…çš„çŸ¥è¯†åº“
        pkg_dir = self.packager.pkg_dir
        if os.path.exists(pkg_dir):
            import time
            pkgs = [f for f in os.listdir(pkg_dir) if f.endswith('.kbpkg')]
            
            for pkg in sorted(pkgs):
                pkg_file = os.path.join(pkg_dir, pkg)
                name = pkg.replace('.kbpkg', ':latest')
                
                # è·å–æ–‡ä»¶ä¿¡æ¯
                stat = os.stat(pkg_file)
                size_gb = stat.st_size / (1024 ** 3)
                
                # ç”Ÿæˆç®€çŸ­ IDï¼ˆå‰12ä½å“ˆå¸Œï¼‰
                import hashlib
                with open(pkg_file, 'rb') as f:
                    file_id = hashlib.sha256(f.read(512)).hexdigest()[:12]
                
                # ä¿®æ”¹æ—¶é—´
                mod_time = time.time() - stat.st_mtime
                if mod_time < 86400:
                    mod_str = f"{int(mod_time/3600)} hours ago"
                elif mod_time < 604800:
                    mod_str = f"{int(mod_time/86400)} days ago"
                else:
                    mod_str = f"{int(mod_time/604800)} weeks ago"
                
                print(f"{name:<40} {file_id:<16} {size_gb:<9.0f}GB {mod_str}")
    
    def pull(self, kb_name):
        """æ‰“åŒ…çŸ¥è¯†åº“ï¼ˆç±»ä¼¼ ollama pullï¼‰"""
        print(f"pulling knowledge base '{kb_name}'...")
        
        # å»æ‰ :latest åç¼€
        kb_name = kb_name.replace(':latest', '')
        
        result = self.packager.package(kb_name)
        if result:
            print(f"success")
        else:
            print(f"Error: failed to package '{kb_name}'")
            sys.exit(1)
    
    def run(self, kb_name, query=None):
        """è¿è¡ŒçŸ¥è¯†åº“é—®ç­”ï¼ˆç±»ä¼¼ ollama runï¼‰"""
        # å»æ‰ :latest åç¼€
        kb_name = kb_name.replace(':latest', '')
        pkg_file = os.path.join(self.packager.pkg_dir, f"{kb_name}.kbpkg")
        
        if not os.path.exists(pkg_file):
            print(f"Error: knowledge base '{kb_name}' not found")
            print(f"Try 'kbllama pull {kb_name}' first")
            sys.exit(1)
        
        # è®¾ç½®åµŒå…¥æ¨¡å‹
        from llama_index.embeddings.huggingface import HuggingFaceEmbedding
        from llama_index.core import Settings
        Settings.embed_model = HuggingFaceEmbedding(model_name="BAAI/bge-small-zh-v1.5")
        
        # åŠ è½½çŸ¥è¯†åº“
        print(f">>> Loading knowledge base '{kb_name}'...")
        index = self.packager.load(pkg_file)
        
        if not index:
            print(f"Error: failed to load '{kb_name}'")
            sys.exit(1)
        
        # åˆ›å»ºé—®ç­”å¼•æ“
        from llama_index.core.memory import ChatMemoryBuffer
        chat_engine = index.as_chat_engine(
            chat_mode="context",
            memory=ChatMemoryBuffer.from_defaults(token_limit=4000),
            system_prompt="ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„çŸ¥è¯†åº“åŠ©æ‰‹ã€‚"
        )
        
        print(f">>> Knowledge base '{kb_name}' is ready!")
        print(f">>> Send a message (/? for help)")
        print()
        
        # å¦‚æœæä¾›äº†æŸ¥è¯¢ï¼Œç›´æ¥å›ç­”
        if query:
            print(f">>> {query}")
            response = chat_engine.chat(query)
            print(response.response)
            print()
            return
        
        # äº¤äº’å¼å¯¹è¯
        while True:
            try:
                user_input = input(">>> ")
                
                if not user_input.strip():
                    continue
                
                if user_input == "/bye":
                    print("Goodbye!")
                    break
                
                if user_input == "/?":
                    print("Available commands:")
                    print("  /bye    - Exit")
                    print("  /?      - Help")
                    continue
                
                # é—®ç­”
                response = chat_engine.chat(user_input)
                print(response.response)
                print()
                
            except KeyboardInterrupt:
                print("\nGoodbye!")
                break
            except EOFError:
                break
    
    def show(self, kb_name):
        """æ˜¾ç¤ºçŸ¥è¯†åº“ä¿¡æ¯ï¼ˆç±»ä¼¼ ollama showï¼‰"""
        kb_name = kb_name.replace(':latest', '')
        pkg_file = os.path.join(self.packager.pkg_dir, f"{kb_name}.kbpkg")
        
        if not os.path.exists(pkg_file):
            print(f"Error: knowledge base '{kb_name}' not found")
            sys.exit(1)
        
        self.packager.info(pkg_file)
        
        # æ˜¾ç¤º Modelfile
        modelfile = os.path.join(self.packager.pkg_dir, f"{kb_name}.Modelfile")
        if os.path.exists(modelfile):
            print("\nğŸ“„ Modelfile:")
            with open(modelfile, 'r') as f:
                print(f.read())
    
    def rm(self, kb_name):
        """åˆ é™¤çŸ¥è¯†åº“ï¼ˆç±»ä¼¼ ollama rmï¼‰"""
        kb_name = kb_name.replace(':latest', '')
        pkg_file = os.path.join(self.packager.pkg_dir, f"{kb_name}.kbpkg")
        modelfile = os.path.join(self.packager.pkg_dir, f"{kb_name}.Modelfile")
        
        if not os.path.exists(pkg_file):
            print(f"Error: knowledge base '{kb_name}' not found")
            sys.exit(1)
        
        # åˆ é™¤æ–‡ä»¶
        os.remove(pkg_file)
        if os.path.exists(modelfile):
            os.remove(modelfile)
        
        print(f"deleted '{kb_name}'")


def main():
    parser = argparse.ArgumentParser(
        prog='kbllama',
        description='Ollama-style knowledge base manager',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  kbllama list                    # List all knowledge bases
  kbllama pull 20251203           # Package a knowledge base
  kbllama run 20251203            # Interactive Q&A
  kbllama run 20251203 "é—®é¢˜"     # Single query
  kbllama show 20251203           # Show info
  kbllama rm 20251203             # Remove knowledge base
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # list
    subparsers.add_parser('list', help='List knowledge bases')
    
    # pull
    pull_parser = subparsers.add_parser('pull', help='Package knowledge base')
    pull_parser.add_argument('name', help='Knowledge base name')
    
    # run
    run_parser = subparsers.add_parser('run', help='Run knowledge base Q&A')
    run_parser.add_argument('name', help='Knowledge base name')
    run_parser.add_argument('query', nargs='?', help='Query (optional, for single question)')
    
    # show
    show_parser = subparsers.add_parser('show', help='Show knowledge base info')
    show_parser.add_argument('name', help='Knowledge base name')
    
    # rm
    rm_parser = subparsers.add_parser('rm', help='Remove knowledge base')
    rm_parser.add_argument('name', help='Knowledge base name')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    kbllama = KBLlama()
    
    if args.command == 'list':
        kbllama.list()
    elif args.command == 'pull':
        kbllama.pull(args.name)
    elif args.command == 'run':
        kbllama.run(args.name, args.query)
    elif args.command == 'show':
        kbllama.show(args.name)
    elif args.command == 'rm':
        kbllama.rm(args.name)


if __name__ == '__main__':
    main()
